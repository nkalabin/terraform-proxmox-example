# Terraform –º–æ–¥—É–ª—å –¥–ª—è Proxmox VE

–≠—Ç–æ—Ç –ø—Ä–æ–µ–∫—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç Terraform –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã—Ö –º–∞—à–∏–Ω –≤ Proxmox VE –∏–∑ –≥–æ—Ç–æ–≤—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤. –ú–æ–¥—É–ª—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –Ω–∞—Å—Ç—Ä–æ–π–∫—É cloud-init, —Å–µ—Ç–µ–≤—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∏ —Ä–µ—Å—É—Ä—Å–æ–≤ VM —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ.

## –ß—Ç–æ –¥–µ–ª–∞–µ—Ç —ç—Ç–æ—Ç –º–æ–¥—É–ª—å

- üñ•Ô∏è –°–æ–∑–¥–∞–µ—Ç –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ –º–∞—à–∏–Ω—ã –∏–∑ —à–∞–±–ª–æ–Ω–æ–≤ Proxmox
- ‚öôÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç cloud-init –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- üåê –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä—É–µ—Ç —Å–µ—Ç–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏ IP –∞–¥—Ä–µ—Å–∞—Ü–∏—é
- üîß –ü–æ–∑–≤–æ–ª—è–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å —Ä–µ—Å—É—Ä—Å—ã VM (CPU, –ø–∞–º—è—Ç—å, –¥–∏—Å–∫)
- üè∑Ô∏è –î–æ–±–∞–≤–ª—è–µ—Ç —Ç–µ–≥–∏ –∏ –º–µ—Ç–∫–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è VM

## üöÄ –ë—ã—Å—Ç—Ä—ã–π —Å—Ç–∞—Ä—Ç

### 1. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞

–°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø—Ä–∏–º–µ—Ä –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∏ –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ—é —Å—Ä–µ–¥—É:
```bash
cp terraform.tfvars.example terraform.tfvars
nano terraform.tfvars  # –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π —Ä–µ–¥–∞–∫—Ç–æ—Ä
```

### 2. –ù–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ `terraform.tfvars`

–í —Ñ–∞–π–ª–µ `terraform.tfvars` –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –∏–∑–º–µ–Ω–∏—Ç–µ:

**–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Proxmox:**
- `proxmox_api_url` - URL –≤–∞—à–µ–≥–æ Proxmox —Å–µ—Ä–≤–µ—Ä–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: `https://192.168.1.100:8006/api2/json`)
- `proxmox_api_token_id` - ID —Ç–æ–∫–µ–Ω–∞ API (–Ω–∞–ø—Ä–∏–º–µ—Ä: `root@pam!terraform`)
- `proxmox_api_token_secret` - –°–µ–∫—Ä–µ—Ç–Ω—ã–π –∫–ª—é—á —Ç–æ–∫–µ–Ω–∞

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã VM:**
- `target_node` - –∏–º—è —É–∑–ª–∞ Proxmox –≥–¥–µ —Å–æ–∑–¥–∞–µ—Ç—Å—è VM
- `template_name` - –∏–º—è —à–∞–±–ª–æ–Ω–∞ –¥–ª—è –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
- `vm_name` - –∏–º—è —Å–æ–∑–¥–∞–≤–∞–µ–º–æ–π –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
- `vm_user` –∏ `vm_password` - –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è cloud-init

### 3. –ó–∞–ø—É—Å–∫

```bash
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Terraform
terraform init

# –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–ª–∞–Ω–∞ —Å–æ–∑–¥–∞–Ω–∏—è
terraform plan

# –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω—ã
terraform apply
```

## ‚öôÔ∏è –ü–æ–¥—Ä–æ–±–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

### –°–æ–∑–¥–∞–Ω–∏–µ API —Ç–æ–∫–µ–Ω–∞ –≤ Proxmox

–î–ª—è —Ä–∞–±–æ—Ç—ã —Å Proxmox —á–µ—Ä–µ–∑ Terraform –Ω—É–∂–µ–Ω API —Ç–æ–∫–µ–Ω:

1. –í–æ–π–¥–∏—Ç–µ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å Proxmox
2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ **Datacenter** ‚Üí **Permissions** ‚Üí **API Tokens**
3. –ù–∞–∂–º–∏—Ç–µ **Add** ‚Üí **API Token**
4. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ:
   - **User ID**: `root@pam!terraform` (–∏–ª–∏ –¥—Ä—É–≥–æ–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å)
   - **Token ID**: –ª—é–±–æ–µ –∏–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä: `terraform`)
   - **Expire**: –æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º –¥–ª—è –±–µ—Å—Å—Ä–æ—á–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω–∞
5. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ –ø–æ–ª—É—á–µ–Ω–Ω—ã–π **Token ID** –∏ **Secret**

### –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ —à–∞–±–ª–æ–Ω–∞ VM

–ü–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º —à–∞–±–ª–æ–Ω –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–ª—è cloud-init. –í—ã–ø–æ–ª–Ω–∏—Ç–µ —Å–ª–µ–¥—É—é—â–∏–µ –∫–æ–º–∞–Ω–¥—ã –≤ –≤–∞—à–µ–º —à–∞–±–ª–æ–Ω–µ:
```bash
# --- Cloud-init –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ ---
rm -f /etc/cloud/cloud.cfg.d/99-installer.cfg || true
rm -f /etc/cloud/cloud-init.disabled || true
mkdir -p /etc/cloud/cloud.cfg.d
printf "%s\n" "datasource_list: [ NoCloud, ConfigDrive, OVF, MAAS, VMware, OpenStack, CloudStack, Ec2, Azure, GCE, Oracle, Aliyun ]" > /etc/cloud/cloud.cfg.d/99_enable_all_datasources.cfg

# --- –ù–∞—Å—Ç—Ä–æ–π–∫–∞ GRUB ---
if [ -f /etc/default/grub ]; then
  sed -i "s#^GRUB_CMDLINE_LINUX_DEFAULT=.*#GRUB_CMDLINE_LINUX_DEFAULT=\"console=tty0 console=ttyS0,115200 earlycon=ttyS0,115200 loglevel=7\"#" /etc/default/grub || true
  sed -i "s#^GRUB_CMDLINE_LINUX=.*#GRUB_CMDLINE_LINUX=\"\"#" /etc/default/grub || true
  command -v update-grub >/dev/null 2>&1 && update-grub || true
fi

# --- –û—á–∏—Å—Ç–∫–∞ apt ---
apt-get -y autoremove || true
apt-get clean || true

# --- machine-id ---
if [ -f /etc/machine-id ]; then truncate -s 0 /etc/machine-id || true; fi
rm -f /var/lib/dbus/machine-id || true
ln -sf /etc/machine-id /var/lib/dbus/machine-id || true

# --- –û—á–∏—Å—Ç–∫–∞ SSH host keys ---
rm -f /etc/ssh/ssh_host_* || true

# --- –ó–∞–Ω—É–ª–µ–Ω–∏–µ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –º–µ—Å—Ç–∞ ---
set +e
dd if=/dev/zero of=/EMPTY bs=1M count=1024 >/dev/null 2>&1 || true
rm -f /EMPTY
set -e
sync
echo "‚úÖ Cloud-init, GRUB –∏ –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω—ã."
```

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

**‚ö†Ô∏è –í–ê–ñ–ù–û**: –§–∞–π–ª `terraform.tfvars` —Å–æ–¥–µ—Ä–∂–∏—Ç —Å–µ–∫—Ä–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ù–ï –¥–æ–ª–∂–µ–Ω –ø–æ–ø–∞–¥–∞—Ç—å –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π!

- ‚úÖ –§–∞–π–ª `terraform.tfvars` —É–∂–µ –¥–æ–±–∞–≤–ª–µ–Ω –≤ `.gitignore`
- ‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ `terraform.tfvars.example` –∫–∞–∫ —à–∞–±–ª–æ–Ω
- üîë –•—Ä–∞–Ω–∏—Ç–µ —Ç–æ–∫–µ–Ω—ã API –∏ –ø–∞—Ä–æ–ª–∏ –≤ –±–µ–∑–æ–ø–∞—Å–Ω–æ–º –º–µ—Å—Ç–µ
- üåê –î–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ `proxmox_tls_insecure = false`

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

```
proxmox-terraform/
‚îú‚îÄ‚îÄ main.tf                    # –û—Å–Ω–æ–≤–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è VM
‚îú‚îÄ‚îÄ variables.tf               # –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
‚îú‚îÄ‚îÄ outputs.tf                 # –í—ã–≤–æ–¥—ã –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è
‚îú‚îÄ‚îÄ versions.tf                # –í–µ—Ä—Å–∏–∏ –ø—Ä–æ–≤–∞–π–¥–µ—Ä–æ–≤
‚îú‚îÄ‚îÄ terraform.tfvars          # –í–∞—à–∏ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ (–ù–ï –∫–æ–º–º–∏—Ç–∏—Ç—å!)
‚îú‚îÄ‚îÄ terraform.tfvars.example  # –ü—Ä–∏–º–µ—Ä –Ω–∞—Å—Ç—Ä–æ–µ–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã
‚îú‚îÄ‚îÄ .gitignore                # –ò—Å–∫–ª—é—á–µ–Ω–∏—è –¥–ª—è Git (—É–∂–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
‚îî‚îÄ‚îÄ README.md                 # –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –ø—Ä–æ–µ–∫—Ç–∞
```

## ‚ú® –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

- ‚úÖ –ü–æ–ª–Ω–æ–µ –∫–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–æ–≤ VM (`full_clone = true`)
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ cloud-init –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ SSH –∫–ª—é—á–µ–π –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞
- ‚úÖ –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–µ —Ä–µ—Å—É—Ä—Å—ã (CPU —è–¥—Ä–∞, –ø–∞–º—è—Ç—å, —Ä–∞–∑–º–µ—Ä –¥–∏—Å–∫–∞)
- ‚úÖ –ì–∏–±–∫–∞—è —Å–µ—Ç–µ–≤–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (VLAN, –º–æ—Å—Ç—ã)
- ‚úÖ –¢–µ–≥–∏ –∏ –º–µ—Ç–∫–∏ –¥–ª—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–∏ VM
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤

## –£—Å—Ç—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ–ø–æ–ª–∞–¥–æ–∫

### –û—à–∏–±–∫–∞ "no bootable device"

–ï—Å–ª–∏ VM –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ:

1. **–¢–∏–ø –¥–∏—Å–∫–∞ –≤ —à–∞–±–ª–æ–Ω–µ:**
   ```bash
   qm config <template_id>
   ```

2. **–ò–∑–º–µ–Ω–∏—Ç–µ –ø–∞—Ä–∞–º–µ—Ç—Ä `boot` –≤ `main.tf`:**
   - –ï—Å–ª–∏ `bootdisk: scsi0` ‚Üí `boot = "order=scsi0"`
   - –ï—Å–ª–∏ `bootdisk: virtio0` ‚Üí `boot = "order=virtio0"`
   - –ï—Å–ª–∏ `bootdisk: ide0` ‚Üí `boot = "order=ide0"`

### –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ VM

–ü–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è VM –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å —á–µ—Ä–µ–∑ SSH:
```bash
ssh <vm_user>@<vm_ip_address>
```

## –£–¥–∞–ª–µ–Ω–∏–µ

–î–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤:
```bash
terraform destroy
```

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT